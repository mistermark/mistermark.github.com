!function(a){a.fn.flickrHeist=function(b){"use strict";var c=a.extend({},a.fn.flickrHeist.defaults,b),d={REST_URL:"http://www.flickr.com/services/rest/",SEARCH:"flickr.photos.search",GETINFO:"flickr.photos.getInfo",APIKEY:c.apikey,FORMAT:"json"};d.PARAMS={SEARCH:{api_key:d.APIKEY,method:d.SEARCH,format:d.FORMAT,tags:c.tags,safe_search:c.safe_search,pages:"1",per_page:c.number_photos,nojsoncallback:"1",sort:c.sortby,extras:c.size+",geo,owner_name",has_geo:"1",min_upload_date:c.min_date},GETINFO:{method:d.GETINFO,api_key:d.APIKEY,format:d.FORMAT,nojsoncallback:"1",photo_id:null}};var e={status:null,target:this,today:(new Date).setHours(0,0,0,0),jsonmodel:{creation_date:null,real_total:null,items:[]},photoSearchUrl:d.REST_URL+"?"+a.param(d.PARAMS.SEARCH)};e.jsonmodel.creation_date=e.today;var f=function(){e.status="initialized",l()},g=function(a){return localStorage&&localStorage.getItem("flickrHeist")?!0:a},h=function(){return window.location.search.indexOf("flickrheist=debug")&&c.debug++,c.debug===!0&&c.debug++,c.debug},i=function(){return JSON.parse(localStorage.getItem("flickrHeist"))},j=function(a){(g(a)!==!0||a.creation_date!==e.today)&&localStorage.setItem("flickrHeist",JSON.stringify(a))},k=function(a){return Math.floor(Math.random()*a.real_total)},l=function(){g(e.jsonmodel)===!0&&h()<=0?n(i()):a.ajax({url:e.photoSearchUrl,dataType:"json",data:JSON,error:function(a,b){throw new Error(b)},success:function(b){e.jsonmodel.real_total=0,a.each(b.photos.photo,function(a,b){void 0!==b[c.size]&&(e.jsonmodel.real_total++,e.jsonmodel.items.push({id:b.id,details:{src:b[c.size],title:b.title,ownername:"",place_id:b.place_id,geo:{city:"",country:""},page_url:""}}))}),j(e.jsonmodel),n(e.jsonmodel)}})},m=function(b){var f=b.id,g=d.PARAMS.GETINFO,h=d.REST_URL+"?"+a.param(a.extend(g,{photo_id:f}));a.ajax({url:h,dataType:"json",data:JSON,error:function(a,b){throw new Error(b)},success:function(a){var b={owner:a.photo.owner.realname||a.photo.owner.username||"",location:a.photo.location.country._content||"",url:a.photo.urls.url[0]._content,title:a.photo.title._content},d=Handlebars.compile(c.creditstemplate);e.target.append(d(b))}})},n=function(a){var b=a.items[k(a)],d=Handlebars.compile(c.phototemplate);m(b),e.target.html(d(b)),o()},o=function(){a.isFunction(c.complete)&&c.complete.call()};return f()},a.fn.flickrHeist.defaults={apikey:null,tags:"zeitgeist",safe_search:"0",number_photos:"31",sortby:"interestingness-desc",random:!0,size:"url_c",min_date:"1330560000",debug:!0,phototemplate:'<div class="cover-image" style="background-image: url({{details.src}})">',creditstemplate:'<div class="cover-details"><ul class="clearfix"><li class="cover-owner"><a href="{{url}}" title="{{title}}">{{owner}}</a></li><li class="cover-location">{{location}}</li></ul></div>',complete:null}}(jQuery);